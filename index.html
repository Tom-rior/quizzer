<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Maker Pro</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 450px; width: 100%; }
        h2 { color: #333; text-align: center; margin-bottom: 1.5rem; }
        label { font-weight: bold; display: block; margin-top: 1rem; color: #555; }
        input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; border: none; padding: 12px; width: 100%; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 1.5rem; }
        button:hover { background-color: #0056b3; }
        #output { margin-top: 1rem; text-align: center; font-weight: bold; color: #28a745; }
    </style>
</head>
<body>

    <div class="card">
        <h2>üìù Mega Quiz Maker</h2>
        
        <label>1. Upload CSV File(s)</label>
        <input type="file" id="csv-upload" accept=".csv" multiple>
        
        <label>2. Number of Questions</label>
        <input type="number" id="num-q" value="10" min="1">

        <button id="gen-btn" py-click="generate_quiz">üöÄ Generate Quiz & Key</button>
        
        <div id="output">Upload files to start</div>
    </div>

    <section class="pyscript">
        <script type="py" config='{"packages":["pandas", "python-docx"]}'>
            import pandas as pd
            from docx import Document
            from js import document, Uint8Array, window, Blob
            import io
            import csv

            def download_file(content, filename, file_type):
                blob = Blob.new([content], {type: file_type})
                url = window.URL.createObjectURL(blob)
                link = document.createElement("a")
                link.href = url
                link.download = filename
                link.click()
                window.URL.revokeObjectURL(url)

            async def generate_quiz(event):
                output_div = document.getElementById("output")
                output_div.innerText = "‚è≥ Mixing questions..."
                
                file_list = document.getElementById("csv-upload").files
                if len(file_list) == 0:
                    output_div.innerText = "‚ùå No files uploaded!"
                    return

                try:
                    # 1. Load All CSVs
                    all_dfs = []
                    for i in range(len(file_list)):
                        file = file_list.item(i)
                        array_buffer = await file.arrayBuffer()
                        df = pd.read_csv(io.BytesIO(array_buffer.to_py()))
                        
                        # Fix Columns
                        rename_map = {df.columns[j]: name for j, name in enumerate(['Question', 'A', 'B', 'C', 'D', 'Answer'])}
                        df = df.rename(columns=rename_map)
                        all_dfs.append(df)

                    final_df = pd.concat(all_dfs).drop_duplicates(subset=['Question']).dropna()

                    # 2. Pick Random
                    num = int(document.getElementById("num-q").value)
                    selected = final_df.sample(n=min(num, len(final_df))).to_dict('records')

                    # 3. Build Word Doc
                    doc = Document()
                    doc.add_heading('Quiz', 0)
                    for i, q in enumerate(selected, 1):
                        p = doc.add_paragraph()
                        p.add_run(f"Q{i}. {q['Question']}").bold = True
                        for opt in ['A', 'B', 'C', 'D']:
                            doc.add_paragraph(f"{opt}. {q[opt]}")
                        doc.add_paragraph()

                    # 4. Build CSV Answer Key
                    csv_output = io.StringIO()
                    writer = csv.writer(csv_output, quoting=csv.QUOTE_ALL)
                    writer.writerow(["Q No", "KEY"])
                    for i, q in enumerate(selected, 1):
                        writer.writerow([str(i), q['Answer']])

                    # 5. Download Both
                    # Word File
                    doc_io = io.BytesIO()
                    doc.save(doc_io)
                    download_file(Uint8Array.new(doc_io.getvalue()), "quiz.docx", "application/vnd.openxmlformats-officedocument.wordprocessingml.document")
                    
                    # CSV File
                    csv_bytes = csv_output.getvalue().encode('utf-8')
                    download_file(Uint8Array.new(csv_bytes), "answer_key.csv", "text/csv")

                    output_div.innerText = "‚úÖ Both files downloaded!"
                
                except Exception as e:
                    output_div.innerText = f"‚ùå Error: {str(e)}"
        </script>
    </section>

</body>
</html>
